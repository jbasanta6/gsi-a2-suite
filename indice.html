
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GSI A2 – Suite de Estudio</title>
  <link rel="manifest" href="manifiesto.webmanifest" />
  <meta name="theme-color" content="#0b0b0b" />
  <script>if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js'));}</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>@media print { .no-print { display:none !important; } }</style>
</head>
<body class="bg-neutral-50">
  <div id="root"></div>
  <script type="text/babel">
  const { useEffect, useMemo, useState } = React;
  const todayStr = () => new Date().toISOString().slice(0,10);
  const addDays = (d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10)};
  const STORAGE = 'gsi_a2_state_v3';
  const IMPORT_FLAG = 'gsi_a2_mc_v1';

  async function fetchJSON(path){ try{ const r = await fetch(path); if(!r.ok) return null; return await r.json(); } catch { return null; } }

  function sm2(state, quality){
    let { ease=2.5, interval=0, reps=0 } = state || {};
    if (quality<3){ reps=0; interval=1; }
    else {
      reps=(reps||0)+1;
      if (reps===1) interval=1; else if (reps===2) interval=6; else interval=Math.round(interval*ease);
      ease=ease+0.1-(5-quality)*(0.08+(5-quality)*0.02);
      if (ease<1.3) ease=1.3;
    }
    return { ease, interval, reps, due:addDays(todayStr(), interval) };
  }

  function load(){ try{const r=localStorage.getItem(STORAGE); return r?JSON.parse(r):null;}catch{return null;} }
  function save(s){ localStorage.setItem(STORAGE, JSON.stringify(s)); }

  function App(){
    const [topics, setTopics] = useState([]);
    const [state, setState] = useState(null);
    const [tab, setTab] = useState('estudio');
    const [curTopic, setCurTopic] = useState('');

    // Carga de temas.json
    useEffect(()=>{ (async()=>{
      const t = await fetchJSON('./temas.json') || [];
      setTopics(t);
      const s = load() || ({ created: todayStr(), topics: t, notes:{}, flashcards:[], fcProgress:{}, tests:[], testResults:{}, daily:{targetFC:40,targetQ:20} });
      setState(s); setCurTopic(t[0]?.id || '');
      // Auto-importar Marco Constitucional (t1) solo una vez
      if (!localStorage.getItem(IMPORT_FLAG)){
        const fc = await fetchJSON('./assets/marco-constitucional/flashcards_marco_constitucional.json') || [];
        const qs = await fetchJSON('./assets/marco-constitucional/tests_marco_constitucional.json') || [];
        const notes = s.notes['t1'] || {text:'',links:[],videos:[]};
        const base = './assets/marco-constitucional/';
        const links = [
          base+'resumen_marco_constitucional.pdf',
          base+'mapa_mental_marco_constitucional.pdf',
          base+'mapa_mental_marco_constitucional.png'
        ];
        const merged = {...s, flashcards:[...s.flashcards, ...fc], tests:[...s.tests, ...qs], notes:{...s.notes, t1:{...notes, links:[...notes.links, ...links]}} };
        setState(merged); save(merged); localStorage.setItem(IMPORT_FLAG,'1');
      }
    })(); }, []);

    useEffect(()=>{ if(state) save(state); }, [state]);

    if (!state) return <div className="p-6">Cargando…</div>;

    const topicMap = Object.fromEntries((state.topics||topics).map(t=>[t.id,t]));
    const notes = state.notes[curTopic] || { text:'', links:[], videos:[] };

    // --- Flashcards helpers ---
    const dueToday = (()=>{
      const today = todayStr();
      const pri = t => topicMap[t]?.stars || 1;
      return state.flashcards
        .map(c=>({...c, st: state.fcProgress[c.id], pri: pri(c.topic)}))
        .map(c=>({...c, due: c.st?.due || today}))
        .filter(c=>c.due<=today)
        .sort((a,b)=>(a.due===b.due? (b.pri-a.pri) : a.due.localeCompare(b.due)));
    })();
    const learning = (()=>{
      const today = todayStr();
      const pri = t => topicMap[t]?.stars || 1;
      return state.flashcards
        .filter(c => !(state.fcProgress[c.id]?.due && state.fcProgress[c.id].due>today))
        .map(c => ({...c, pri: pri(c.topic), reps: state.fcProgress[c.id]?.reps||0}))
        .sort((a,b)=>(b.pri-a.pri)||(a.reps-b.reps));
    })();
    const target = state.daily.targetFC;
    const base = dueToday.slice(0,target);
    const ids = new Set(base.map(c=>c.id));
    for (const c of learning){ if (ids.size>=target) break; if(!ids.has(c.id)) ids.add(c.id); }
    const fcSession = state.flashcards.filter(c=>ids.has(c.id));
    const [fcIndex, setFcIndex] = useState(0);
    const [showAnswer, setShowAnswer] = useState(false);
    const fc = fcSession[fcIndex];
    const answerFC = (q) => {
      const cs = state.fcProgress[fc.id] || {};
      const upd = sm2(cs, q);
      const merged = {...state, fcProgress:{...state.fcProgress, [fc.id]: {...cs, ...upd, last: todayStr(), seen:(cs.seen||0)+1, correct:(cs.correct||0)+(q>=3?1:0), wrong:(cs.wrong||0)+(q<3?1:0)}}};
      setState(merged); setShowAnswer(false); setFcIndex(i=>Math.min(i+1, fcSession.length));
    };

    const [testTopic, setTestTopic] = useState('all');
    const qs = state.tests.filter(q => testTopic==='all' || q.topic===testTopic);
    const [qIndex, setQIndex] = useState(0);
    const [choice, setChoice] = useState(null);
    const q = qs[qIndex];
    const nextQ = () => {
      if (choice!=null){
        const correct = (choice===q.answerIndex);
        const merged = {...state, testResults:{...state.testResults, [q.id || (q.text.slice(0,20))]: { seen: ((state.testResults[q.id || (q.text.slice(0,20))]?.seen)||0)+1, correct: ((state.testResults[q.id || (q.text.slice(0,20))]?.correct)||0)+(correct?1:0) }}};
        setState(merged);
      }
      setChoice(null); setQIndex(i => (i+1) % Math.max(qs.length,1));
    };

    function exportPDF(){ window.print(); }

    const [tabSel, setTabSel] = useState('estudio');

    return (
      <div className="min-h-screen text-neutral-900 p-4">
        <div className="max-w-6xl mx-auto">
          <header className="flex flex-col gap-2 md:flex-row md:items-end md:justify-between mb-4 no-print">
            <div>
              <h1 className="text-2xl font-bold">GSI A2 – Suite de Estudio</h1>
              <p className="text-sm text-neutral-600">Temas priorizados, apuntes, vídeos, flashcards, test y plan diario. PWA.</p>
            </div>
            <nav className="flex gap-2 flex-wrap">
              {['estudio','temas','flash','tests','progreso'].map(t => (
                <button key={t} onClick={()=>setTabSel(t)} className={`px-3 py-1 rounded-2xl border ${tabSel===t?'bg-black text-white':''}`}>{t.toUpperCase()}</button>
              ))}
            </nav>
          </header>

          {tabSel==='estudio' && (
            <section className="grid lg:grid-cols-2 gap-4">
              <div className="bg-white rounded-2xl shadow p-4">
                <h2 className="font-semibold mb-2">Plan diario</h2>
                <div className="text-sm text-neutral-600">Fecha: {todayStr()}</div>
                <ul className="list-disc pl-5 text-sm mt-2">
                  {[...state.topics].sort((a,b)=>b.stars-a.stars).slice(0,6).map(t => <li key={t.id}>{t.name} {t.stars>=3?'★':''}</li>)}
                </ul>
                <div className="grid grid-cols-2 gap-3 mt-3">
                  <div className="p-3 border rounded-xl">Flashcards hoy: <b>{state.daily.targetFC}</b></div>
                  <div className="p-3 border rounded-xl">Preguntas test hoy: <b>{state.daily.targetQ}</b></div>
                </div>
              </div>

              <div className="bg-white rounded-2xl shadow p-4">
                <h2 className="font-semibold mb-2">Sesión rápida de Flashcards</h2>
                {fc ? (
                  <div>
                    <div className="text-xs text-neutral-500 mb-2">Tema: {(topicMap[fc.topic]||{}).name}</div>
                    <div className="bg-neutral-50 border rounded-2xl p-4 mb-3">
                      <div className="text-lg font-medium">{fc.q}</div>
                      {showAnswer && <div className="mt-3 p-3 border rounded bg-white">{fc.a}</div>}
                    </div>
                    {!showAnswer ? (
                      <button className="px-4 py-2 rounded-2xl bg-black text-white" onClick={()=>setShowAnswer(true)}>Mostrar respuesta</button>
                    ) : (
                      <div className="grid grid-cols-2 md:grid-cols-6 gap-2">
                        {[0,1,2,3,4,5].map(q => (
                          <button key={q} onClick={()=>answerFC(q)} className="px-3 py-2 rounded-2xl border">
                            {q===0?'Olvido':q===1?'Muy difícil':q===2?'Difícil':q===3?'Normal':q===4?'Fácil':'Muy fácil'}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                ) : <div className="text-neutral-600">No hay tarjetas para hoy.</div>}
              </div>
            </section>
          )}

          {tabSel==='temas' && (
            <section className="bg-white rounded-2xl shadow p-4">
              <h2 className="font-semibold mb-2">Temas & materiales</h2>
              <div className="flex gap-2 mb-3 no-print">
                <select className="border rounded px-2 py-1" value={curTopic} onChange={e=>setCurTopic(e.target.value)}>
                  {state.topics.map(t => <option key={t.id} value={t.id}>{t.name} {t.stars===3?'(***)':t.stars===2?'(**)':'(*)'}</option>)}
                </select>
                <button className="px-3 py-1 border rounded-2xl" onClick={exportPDF}>Exportar a PDF</button>
              </div>
              <div className="grid lg:grid-cols-2 gap-4">
                <div>
                  <label className="text-sm text-neutral-600">Resumen / Apuntes:</label>
                  <textarea className="w-full h-64 border rounded p-2" value={notes.text} onChange={e=>setState(s=>({...s, notes:{...s.notes, [curTopic]: {...notes, text:e.target.value}}}))} placeholder="Aquí verás el resumen generado o tus notas."></textarea>
                </div>
                <div>
                  <label className="text-sm text-neutral-600">Materiales (PDF/imagen) y Vídeos</label>
                  <ul className="list-disc pl-5 text-sm">
                    {(notes.links||[]).map((u,i)=>(<li key={i}><a className="text-blue-600 underline" href={u} target="_blank" rel="noreferrer">{u}</a></li>))}
                  </ul>
                </div>
              </div>
            </section>
          )}

          {tabSel==='flash' && (
            <section className="bg-white rounded-2xl shadow p-4">
              <h2 className="font-semibold mb-2">Flashcards</h2>
              <div className="text-sm text-neutral-600 mb-2">Total: {state.flashcards.length}</div>
              <div className="grid gap-2">
                {state.flashcards.map((c,idx) => (
                  <div key={idx} className="border rounded-xl p-3">
                    <div className="text-xs text-neutral-500">{(topicMap[c.topic]||{}).name}</div>
                    <div className="font-medium">{c.q}</div>
                    <div className="text-sm text-neutral-700">{c.a}</div>
                  </div>
                ))}
              </div>
            </section>
          )}

          {tabSel==='tests' && (
            <section className="bg-white rounded-2xl shadow p-4">
              <h2 className="font-semibold mb-2">Banco de Test</h2>
              <div className="flex gap-2 mb-3 no-print">
                <select className="border rounded px-2 py-1" value={testTopic} onChange={e=>{setTestTopic(e.target.value); setQIndex(0);}}>
                  <option value="all">Todos</option>
                  {state.topics.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                </select>
              </div>
              {q ? (
                <div>
                  <div className="text-xs text-neutral-500 mb-1">{(topicMap[q.topic]||{}).name}</div>
                  <div className="font-medium mb-2">{q.text}</div>
                  <div className="grid gap-2 mb-2">
                    {q.options.map((op,i)=>(
                      <label key={i} className={`border rounded-xl p-2 cursor-pointer ${choice===i?'bg-neutral-100':''}`}>
                        <input type="radio" name="opt" className="mr-2" checked={choice===i} onChange={()=>setChoice(i)} /> {op}
                      </label>
                    ))}
                  </div>
                  {choice!=null && (
                    <div className={`p-3 rounded-xl mb-2 ${choice===q.answerIndex?'bg-green-50 border border-green-200':'bg-red-50 border border-red-200'}`}>
                      {choice===q.answerIndex?'¡Correcto!':'Incorrecto.'} <span className="text-neutral-700">{q.explanation}</span>
                    </div>
                  )}
                  <button className="px-3 py-1 border rounded-2xl no-print" onClick={nextQ}>Siguiente</button>
                  <div className="text-xs text-neutral-500 mt-2">{qIndex+1} / {qs.length}</div>
                </div>
              ) : <div className="text-neutral-600">No hay preguntas aún.</div>}
            </section>
          )}

          {tabSel==='progreso' && (
            <section className="bg-white rounded-2xl shadow p-4">
              <h2 className="font-semibold mb-2">Progreso</h2>
              <div className="grid lg:grid-cols-2 gap-3">
                <div className="border rounded-xl p-3">
                  <div className="font-medium">Flashcards</div>
                  <div className="text-sm">Total: {state.flashcards.length}</div>
                </div>
                <div className="border rounded-xl p-3">
                  <div className="font-medium">Test</div>
                  <div className="text-sm">Preguntas: {state.tests.length}</div>
                </div>
              </div>
              <div className="mt-4 flex gap-2 no-print">
                <button className="px-3 py-1 border rounded-2xl" onClick={()=>{localStorage.removeItem(STORAGE); localStorage.removeItem(IMPORT_FLAG); location.reload();}}>Resetear</button>
              </div>
            </section>
          )}

          <footer className="text-center text-xs text-neutral-500 py-8 no-print">v3 – Autocarga Marco Constitucional (assets/…) · PWA</footer>
        </div>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
